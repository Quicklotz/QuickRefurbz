name: Deploy to Hetzner VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-quickrefurbz
  cancel-in-progress: false

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build local packages
        run: |
          # Build @quickwms/database package
          if [ -d "packages/database" ]; then
            echo "Building @quickwms/database..."
            cd packages/database
            npm ci
            npm run build
            cd ../..
          fi

          # Build @quickwms/api package
          if [ -d "packages/api" ]; then
            echo "Building @quickwms/api..."
            cd packages/api
            npm ci
            npm run build
            cd ../..
          fi

      - name: Install backend dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build backend
        run: npm run build

      - name: Build frontend
        run: npm run build:frontend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            frontend/dist/
            package.json
            package-lock.json
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: ci
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Determine server from repo owner
        id: server
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          echo "Repository owner: $REPO_OWNER"

          if [[ "$REPO_OWNER" == "Quicklotz" ]]; then
            echo "ssh_host=${{ secrets.HETZNER_QL_HOST }}" >> $GITHUB_OUTPUT
            echo "ssh_user=${{ secrets.HETZNER_QL_USER }}" >> $GITHUB_OUTPUT
            echo "ssh_key=${{ secrets.HETZNER_QL_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "ssh_port=${{ secrets.HETZNER_QL_PORT || '22' }}" >> $GITHUB_OUTPUT
            echo "Using Quicklotz server secrets"
          elif [[ "$REPO_OWNER" == "connorodea" ]]; then
            echo "ssh_host=${{ secrets.HETZNER_CO_HOST }}" >> $GITHUB_OUTPUT
            echo "ssh_user=${{ secrets.HETZNER_CO_USER }}" >> $GITHUB_OUTPUT
            echo "ssh_key=${{ secrets.HETZNER_CO_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "ssh_port=${{ secrets.HETZNER_CO_PORT || '22' }}" >> $GITHUB_OUTPUT
            echo "Using connorodea server secrets"
          else
            echo "ERROR: Unknown repository owner: $REPO_OWNER"
            echo "Supported owners: Quicklotz, connorodea"
            exit 1
          fi

      - name: Validate server secrets
        run: |
          if [[ -z "${{ steps.server.outputs.ssh_host }}" ]]; then
            echo "ERROR: SSH host not configured for this repository owner"
            exit 1
          fi
          if [[ -z "${{ steps.server.outputs.ssh_user }}" ]]; then
            echo "ERROR: SSH user not configured for this repository owner"
            exit 1
          fi
          if [[ -z "${{ steps.server.outputs.ssh_key }}" ]]; then
            echo "ERROR: SSH key not configured for this repository owner"
            exit 1
          fi
          echo "All required secrets are configured"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.server.outputs.ssh_key }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ steps.server.outputs.ssh_port }} ${{ steps.server.outputs.ssh_host }} >> ~/.ssh/known_hosts

      - name: Set deployment variables
        id: vars
        run: |
          APP_DIR="${{ secrets.APP_DIR || '/var/www/quickrefurbz' }}"
          SERVICE_NAME="${{ secrets.SERVICE_NAME || 'quickrefurbz' }}"
          echo "app_dir=$APP_DIR" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to: $APP_DIR"
          echo "Service name: $SERVICE_NAME"

      - name: Sync files to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ steps.server.outputs.ssh_port }}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='data/*.db' \
            ./ \
            ${{ steps.server.outputs.ssh_user }}@${{ steps.server.outputs.ssh_host }}:${{ steps.vars.outputs.app_dir }}/

      - name: Run deployment script
        run: |
          ssh -i ~/.ssh/deploy_key \
            -p ${{ steps.server.outputs.ssh_port }} \
            ${{ steps.server.outputs.ssh_user }}@${{ steps.server.outputs.ssh_host }} \
            "cd ${{ steps.vars.outputs.app_dir }} && \
             chmod +x deploy/deploy.sh && \
             APP_DIR=${{ steps.vars.outputs.app_dir }} \
             SERVICE_NAME=${{ steps.vars.outputs.service_name }} \
             ./deploy/deploy.sh"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment complete
        run: |
          echo "Deployment successful!"
          echo "Application: quickrefurbz"
          echo "URL: https://quickrefurbz.com"
