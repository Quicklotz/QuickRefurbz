name: Build & Deploy QuickRefurbz

on:
  push:
    branches: [main]

concurrency:
  group: deploy-quickrefurbz
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install backend dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build backend
        run: npx tsc --outDir dist

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npx vite build

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: dist/
          retention-days: 1

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

      - name: Upload package files
        uses: actions/upload-artifact@v4
        with:
          name: package-files
          path: |
            package.json
            package-lock.json
          retention-days: 1

  deploy:
    name: Deploy to Hetzner QL
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: dist/

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Download package files
        uses: actions/download-artifact@v4
        with:
          name: package-files

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_QL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HETZNER_QL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Rsync backend dist
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            dist/ \
            ${{ secrets.HETZNER_QL_USER }}@${{ secrets.HETZNER_QL_HOST }}:/var/www/quickwms/QuickRefurbz/dist/

      - name: Rsync frontend dist
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            frontend/dist/ \
            ${{ secrets.HETZNER_QL_USER }}@${{ secrets.HETZNER_QL_HOST }}:/var/www/quickwms/QuickRefurbz/frontend/dist/

      - name: Rsync package files
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            package.json package-lock.json \
            ${{ secrets.HETZNER_QL_USER }}@${{ secrets.HETZNER_QL_HOST }}:/var/www/quickwms/QuickRefurbz/

      - name: Install production deps and restart PM2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.HETZNER_QL_USER }}@${{ secrets.HETZNER_QL_HOST }} \
            'cd /var/www/quickwms/QuickRefurbz && npm ci --omit=dev && pm2 restart quickrefurbz --update-env'

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-status:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for server to stabilize
        run: sleep 10

      - name: Health check
        run: |
          response=$(curl -sf --max-time 15 https://quickrefurbz.com/api/health)
          echo "Health check response: $response"
          echo "$response" | grep -q '"status":"ok"' || {
            echo "ERROR: Health check failed"
            exit 1
          }
          echo "Deployment verified successfully"
