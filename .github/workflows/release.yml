name: Release QuickRefurbz

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Build all packages, backend, and frontend
  # ---------------------------------------------------------------------------
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build packages/database
        run: |
          cd packages/database
          npm ci
          npm run build

      - name: Build packages/api
        run: |
          cd packages/api
          npm ci
          npm run build

      - name: Install backend dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            frontend/dist/
            packages/
            package.json
            package-lock.json
            src/
            scripts/
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 2: Package macOS Electron .dmg
  # ---------------------------------------------------------------------------
  package-macos:
    name: Package macOS Electron
    runs-on: macos-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend for Electron
        working-directory: frontend
        env:
          VITE_ELECTRON: 'true'
          VITE_API_BASE: 'https://quickrefurbz.com/api'
        run: |
          npx vite build
          npx tsc -p electron/tsconfig.json
          echo '{"type":"commonjs"}' > dist-electron/package.json

      - name: Build Electron DMG
        working-directory: frontend
        env:
          GH_TOKEN: ${{ github.token }}
        run: npx electron-builder --mac --publish never

      - name: List release output
        run: ls -lh frontend/release/

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            frontend/release/QuickRefurbz*.dmg
            frontend/release/latest-mac.yml
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 3: Package Windows Electron .exe installer
  # ---------------------------------------------------------------------------
  package-windows:
    name: Package Windows Electron
    runs-on: windows-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend for Electron
        working-directory: frontend
        env:
          VITE_ELECTRON: 'true'
          VITE_API_BASE: 'https://quickrefurbz.com/api'
        run: |
          npx vite build
          npx tsc -p electron/tsconfig.json
          echo '{"type":"commonjs"}' > dist-electron/package.json

      - name: Build Electron installer
        working-directory: frontend
        env:
          GH_TOKEN: ${{ github.token }}
        run: npx electron-builder --win --publish never

      - name: List release output
        shell: bash
        run: ls -lh frontend/release/

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-electron
          path: |
            frontend/release/QuickRefurbz*.exe
            frontend/release/latest.yml
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 4: Create GitHub Release with all assets
  # ---------------------------------------------------------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [package-macos, package-windows]
    if: always() && needs.package-windows.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS DMG
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: release-assets/

      - name: Download Windows Electron installer
        uses: actions/download-artifact@v4
        with:
          name: windows-electron
          path: release-assets/

      - name: List release assets
        run: ls -lhR release-assets/

      - name: Create GitHub Release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        run: |
          find release-assets -type f -exec mv {} release-assets/ \; 2>/dev/null || true

          gh release create "$TAG" \
            --title "QuickRefurbz $TAG" \
            --generate-notes \
            release-assets/*

          RELEASE_URL=$(gh release view "$TAG" --json url --jq '.url')
          echo "release_url=${RELEASE_URL}" >> "$GITHUB_OUTPUT"
          echo "Release created: ${RELEASE_URL}"

      - name: Output release URL
        run: echo "Release URL -> ${{ steps.create_release.outputs.release_url }}"

  # ---------------------------------------------------------------------------
  # Job 5: Update Homebrew tap
  # ---------------------------------------------------------------------------
  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.result == 'success'

    steps:
      - name: Update tap formulas
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "HOMEBREW_TAP_TOKEN not set â€” skipping tap update"
            exit 0
          fi

          VERSION="${TAG#v}"

          # Get asset URLs and checksums
          DMG_URL=$(gh release view "$TAG" --repo Quicklotz/QuickRefurbz --json assets --jq '.assets[] | select(.name | endswith(".dmg")) | .url' 2>/dev/null || echo "")
          EXE_URL=$(gh release view "$TAG" --repo Quicklotz/QuickRefurbz --json assets --jq '.assets[] | select(.name | endswith(".exe")) | .url' 2>/dev/null || echo "")

          if [ -n "$DMG_URL" ]; then
            DMG_SHA=$(curl -sL "$DMG_URL" | shasum -a 256 | cut -d' ' -f1)
          fi

          # Clone the tap repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/Quicklotz/homebrew-tools.git" tap
          cd tap

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update Cask if DMG exists
          if [ -n "$DMG_URL" ] && [ -n "$DMG_SHA" ]; then
            mkdir -p Casks
            cat > Casks/quickrefurbz.rb << CASK
          cask "quickrefurbz" do
            version "$VERSION"
            sha256 "$DMG_SHA"

            url "$DMG_URL",
                header: "Authorization: token #{ENV.fetch("HOMEBREW_GITHUB_API_TOKEN", "")}"
            name "QuickRefurbz"
            desc "Refurbishment tracking system for liquidation electronics"
            homepage "https://quickrefurbz.com"

            app "QuickRefurbz.app"

            zap trash: [
              "~/Library/Application Support/QuickRefurbz",
              "~/Library/Preferences/com.quicklotz.quickrefurbz.plist",
            ]
          end
          CASK
          fi

          # Update Formula
          mkdir -p Formula
          TARBALL_URL="https://github.com/Quicklotz/QuickRefurbz/archive/refs/tags/${TAG}.tar.gz"
          TAR_SHA=$(curl -sL "$TARBALL_URL" | shasum -a 256 | cut -d' ' -f1)

          cat > Formula/quickrefurbz-cli.rb << FORMULA
          class QuickrefurbzCli < Formula
            desc "QuickRefurbz CLI tools for refurbishment tracking"
            homepage "https://quickrefurbz.com"
            url "$TARBALL_URL"
            sha256 "$TAR_SHA"
            license "ISC"

            depends_on "node@20"

            def install
              system "npm", "ci", "--omit=dev"
              system "npm", "run", "build"

              libexec.install Dir["*"]
              bin.install_symlink libexec/"dist/index.js" => "qr"
              bin.install_symlink libexec/"dist/enhanced-cli.js" => "quicktestz"
            end

            test do
              assert_match "QuickRefurbz", shell_output("#{bin}/qr --version 2>&1", 0)
            end
          end
          FORMULA

          git add -A
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update QuickRefurbz to ${TAG}"
          git push
          echo "Homebrew tap updated to ${TAG}"
