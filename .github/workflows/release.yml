name: Release QuickRefurbz

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Build all packages, backend, and frontend
  # ---------------------------------------------------------------------------
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build packages/database
        run: |
          cd packages/database
          npm ci
          npm run build

      - name: Build packages/api
        run: |
          cd packages/api
          npm ci
          npm run build

      - name: Install backend dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            frontend/dist/
            packages/
            package.json
            package-lock.json
            src/
            scripts/
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 2: Package macOS .app and .dmg
  # ---------------------------------------------------------------------------
  package-macos:
    name: Package macOS
    runs-on: macos-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Determine tag name
        id: tag
        run: echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create macOS .app bundle
        run: |
          chmod +x scripts/create-macos-app.sh
          bash scripts/create-macos-app.sh

      - name: Codesign .app bundle
        if: env.DEVELOPER_ID != ''
        env:
          DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
        run: |
          codesign --force --deep --sign "$DEVELOPER_ID" QuickTestz.app

      - name: Prepare DMG staging
        run: |
          mkdir -p dmg-staging
          cp -R QuickTestz.app dmg-staging/
          # Add a symlink to /Applications for drag-and-drop install
          ln -s /Applications dmg-staging/Applications

      - name: Create DMG
        env:
          TAG: ${{ steps.tag.outputs.TAG }}
        run: |
          hdiutil create \
            -volname "QuickTestz" \
            -srcfolder dmg-staging \
            -ov \
            -format UDZO \
            "QuickTestz-${TAG}.dmg"

      - name: Codesign DMG
        if: env.DEVELOPER_ID != ''
        env:
          DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
        run: |
          codesign --force --sign "$DEVELOPER_ID" "QuickTestz-${{ steps.tag.outputs.TAG }}.dmg"

      - name: Notarize DMG
        if: env.APPLE_ID != '' && env.APPLE_TEAM_ID != '' && env.APPLE_APP_PASSWORD != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          TAG: ${{ steps.tag.outputs.TAG }}
        run: |
          xcrun notarytool submit "QuickTestz-${TAG}.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          xcrun stapler staple "QuickTestz-${TAG}.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: QuickTestz-${{ steps.tag.outputs.TAG }}.dmg
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 3: Package Windows Electron .exe installer
  # ---------------------------------------------------------------------------
  package-windows:
    name: Package Windows Electron
    runs-on: windows-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend for Electron
        working-directory: frontend
        env:
          VITE_ELECTRON: 'true'
          VITE_API_BASE: 'https://quickrefurbz.com/api'
        run: |
          npx vite build
          npx tsc -p electron/tsconfig.json

      - name: Build Electron installer
        working-directory: frontend
        env:
          GH_TOKEN: ${{ github.token }}
        run: npx electron-builder --win --publish never

      - name: List release output
        shell: bash
        run: ls -lh frontend/release/

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-electron
          path: |
            frontend/release/QuickRefurbz*.exe
            frontend/release/latest.yml
          retention-days: 3

  # ---------------------------------------------------------------------------
  # Job 4: Create GitHub Release with all assets
  # ---------------------------------------------------------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [package-windows]
    if: always() && needs.package-windows.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS DMG
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: release-assets/

      - name: Download Windows Electron installer
        uses: actions/download-artifact@v4
        with:
          name: windows-electron
          path: release-assets/

      - name: List release assets
        run: ls -lhR release-assets/

      - name: Create GitHub Release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        run: |
          # Flatten any nested paths from artifact download
          find release-assets -type f -exec mv {} release-assets/ \; 2>/dev/null || true

          gh release create "$TAG" \
            --title "QuickRefurbz $TAG" \
            --generate-notes \
            release-assets/*

          RELEASE_URL=$(gh release view "$TAG" --json url --jq '.url')
          echo "release_url=${RELEASE_URL}" >> "$GITHUB_OUTPUT"
          echo "Release created: ${RELEASE_URL}"

      - name: Output release URL
        run: echo "Release URL -> ${{ steps.create_release.outputs.release_url }}"
